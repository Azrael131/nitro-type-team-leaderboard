<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>NitroType Leaderboards Aggregator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root {
    --bg: #111317;
    --surface: #151922;
    --surface-2: #1b2130;
    --surface-3: #212838;
    --text: #e8ecf1;
    --text-dim: #b5c0cf;
    --muted: #8b9ab3;
    --accent: #6ea8fe;
    --accent-2: #8fdaff;
    --good: #37d67a;
    --warn: #ffb020;
    --bad: #ff5c5c;
    --border: #2a3244;
    --shadow: rgba(0,0,0,0.35);
    --focus: #82b1ff;

    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;

    --pad-1: 0.4rem;
    --pad-2: 0.66rem;
    --pad-3: 1rem;

    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  html, body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    margin: 0;
    padding: 0;
  }

  .wrap {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--pad-3);
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--pad-2);
    margin-bottom: var(--pad-3);
  }

  .title {
    font-size: 1.6rem;
    font-weight: 700;
    letter-spacing: 0.2px;
  }

  .sub {
    color: var(--muted);
    font-size: 0.95rem;
  }

  .badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text-dim);
    margin-right: 8px;
  }

  .card {
    background: linear-gradient(180deg, var(--surface), var(--surface-2));
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: 0 10px 24px var(--shadow);
    margin-bottom: var(--pad-3);
    overflow: hidden;
  }
  .card h2 {
    margin: 0;
    padding: var(--pad-2) var(--pad-3);
    font-size: 1.15rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface-3);
  }

  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    margin-bottom: var(--pad-2);
    gap: 6px;
    flex-wrap: wrap;
  }
  .tab {
    padding: var(--pad-2) var(--pad-3);
    cursor: pointer;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-bottom: none;
    border-radius: var(--radius-md) var(--radius-md) 0 0;
    color: var(--text-dim);
    user-select: none;
  }
  .tab.active {
    background: var(--surface-3);
    color: var(--text);
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
  }
  thead th {
    text-align: left;
    padding: var(--pad-2) var(--pad-3);
    color: var(--text-dim);
    background: var(--surface-3);
    position: sticky;
    top: 0;
    z-index: 1;
  }
  tbody td {
    padding: var(--pad-2) var(--pad-3);
    border-top: 1px solid var(--border);
    vertical-align: middle;
  }
  tbody tr:hover {
    background: color-mix(in srgb, var(--surface-2) 70%, var(--surface-3));
  }
  .num {
    font-family: var(--mono);
    color: var(--text);
  }
  .muted {
    color: var(--muted);
  }
  .scroll {
    max-height: 560px;
    overflow: auto;
  }

  .error {
    color: var(--bad);
    margin-top: var(--pad-2);
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">NitroType Leaderboards Aggregator</div>
      <div class="sub">This skull scans data.json (team overview exports), deduplicates teams, and builds tabbed top‑100 leaderboards.</div>
    </div>
    <div class="badge" id="lastUpdated">Last updated: —</div>
  </header>

  <div class="card">
    <h2>Summary</h2>
    <div style="padding: var(--pad-3); display: flex; gap: var(--pad-3); flex-wrap: wrap;">
      <div class="badge" id="teamsCount">Teams: 0</div>
      <div class="badge" id="racersCount">Racers: 0</div>
      <div class="badge" id="exportsCount">Exports ingested: 0</div>
      <div class="badge" id="dedupNote">Deduplication: by teamTag (latest export kept)</div>
    </div>
    <div id="errorBox" class="error" style="display:none;"></div>
  </div>

  <div class="card">
    <h2>Leaderboards</h2>
    <div class="tabs">
      <div class="tab active" data-tab="lb-racer-teamRaces">Team races (racers)</div>
      <div class="tab" data-tab="lb-tenure">Longest member since (racers)</div>
      <div class="tab" data-tab="lb-active">Most active (racers)</div>
      <div class="tab" data-tab="lb-team-totals">Team total races (stats.allTime)</div>
    </div>

    <div id="lb-racer-teamRaces" class="tab-content active">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Username</th>
              <th>Team</th>
              <th class="num">Team Races</th>
            </tr>
          </thead>
          <tbody id="tbody-racer-teamRaces"></tbody>
        </table>
      </div>
    </div>

    <div id="lb-tenure" class="tab-content">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Username</th>
              <th>Team</th>
              <th>Member Since</th>
              <th class="num">Parsed Date (ISO)</th>
            </tr>
          </thead>
          <tbody id="tbody-tenure"></tbody>
        </table>
      </div>
    </div>

    <div id="lb-active" class="tab-content">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Username</th>
              <th>Team</th>
              <th>Last Race</th>
              <th class="num">Parsed Date (ISO)</th>
            </tr>
          </thead>
          <tbody id="tbody-active"></tbody>
        </table>
      </div>
    </div>

    <div id="lb-team-totals" class="tab-content">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Team</th>
              <th class="num">All‑Time Races</th>
              <th class="muted">Source</th>
            </tr>
          </thead>
          <tbody id="tbody-team-totals"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // ---- Relative time parsing ----
  function parseRelativeTime(str) {
    if (!str) return new Date(0);
    const s = String(str).trim().toLowerCase();

    if (s === 'never') return new Date(0);
    if (s === 'just now') return new Date();

    // Normalize weird spacing and leading ">"
    const cleaned = s.replace(/^>\s*/, '').replace(/\s+/g, ' ');

    // Patterns like: "a minute ago", "an hour ago", "21 days ago", "4 years ago"
    const m = cleaned.match(/^(a|an|\d+)\s+(second|minute|hour|day|week|month|year)s?\s+ago$/);
    if (!m) return new Date(0);

    let qty = m[1] === 'a' || m[1] === 'an' ? 1 : parseInt(m[1], 10);
    const unit = m[2];

    const msMultipliers = {
      second: 1000,
      minute: 60 * 1000,
      hour:   60 * 60 * 1000,
      day:    24 * 60 * 60 * 1000,
      week:   7 * 24 * 60 * 60 * 1000,
      month:  30 * 24 * 60 * 60 * 1000, // approximation
      year:   365 * 24 * 60 * 60 * 1000
    };
    const delta = (msMultipliers[unit] || 0) * qty;
    return new Date(Date.now() - delta);
  }

  // ---- Helpers ----
  function normNumber(x) {
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }
  function byDescNum(get) { return (a, b) => normNumber(get(b)) - normNumber(get(a)); }
  function byAscDate(get) { return (a, b) => get(a) - get(b); }     // older first
  function byDescDate(get){ return (a, b) => get(b) - get(a); }     // newer first

  function isoDateString(d) {
    if (!(d instanceof Date) || isNaN(d.getTime())) return '—';
    return d.toISOString().replace('T', ' ').slice(0, 19);
  }

  function safeTeamLabel(teamObj) {
    const header = teamObj.header || {};
    const tag = header.teamTag;
    const name = header.teamName;
    return String(tag || name || 'Unknown').trim();
  }

  // ---- Tabs ----
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

  // ---- Data ingestion & dedup (by teamTag, latest exportedAtISO) ----
  async function loadData() {
    try {
      const res = await fetch('data.json', { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();

      // Accept either an array of teams or a single team object
      const teams = Array.isArray(json) ? json : [json];

      // Deduplicate by teamTag (or fallback to teamName), keep the latest exportedAtISO
      const byTag = new Map();
      for (const t of teams) {
        const tag = (t.header && t.header.teamTag) || (t.header && t.header.teamName) || 'Unknown';
        const current = byTag.get(tag);
        const ts = (t.meta && t.meta.exportedAtISO) ? Date.parse(t.meta.exportedAtISO) : 0;
        if (!current) {
          byTag.set(tag, { team: t, ts });
        } else {
          if (ts >= current.ts) byTag.set(tag, { team: t, ts }); // keep latest
        }
      }

      const deduped = Array.from(byTag.values()).map(v => v.team);
      const lastUpdatedISO = new Date(Math.max(...Array.from(byTag.values()).map(v => v.ts))).toISOString();

      return { deduped, ingestedCount: teams.length, lastUpdatedISO };
    } catch (e) {
      const box = document.getElementById('errorBox');
      box.style.display = 'block';
      box.textContent = `Failed to load data.json: ${e.message}`;
      return { deduped: [], ingestedCount: 0, lastUpdatedISO: null };
    }
  }

  function flattenRacers(dedupedTeams) {
    const racers = [];
    for (const t of dedupedTeams) {
      const roster = Array.isArray(t.roster) ? t.roster : [];
      for (const m of roster) {
        racers.push({
          username: String(m.username || ''),
          teamTag: String(m.teamTag || ''),
          memberSinceStr: String(m.memberSince || ''),
          lastRaceStr: String(m.lastRace || ''),
          teamRaces: normNumber(m.teamRaces),
          totalRaces: normNumber(m.totalRaces)
        });
      }
    }
    return racers;
  }

  // ---- Render summary ----
  function renderSummary({ teamsCount, racersCount, ingestedCount, lastUpdatedISO }) {
    document.getElementById('teamsCount').textContent = `Teams: ${teamsCount}`;
    document.getElementById('racersCount').textContent = `Racers: ${racersCount.toLocaleString()}`;
    document.getElementById('exportsCount').textContent = `Exports ingested: ${ingestedCount}`;
    document.getElementById('lastUpdated').textContent =
      `Last updated: ${lastUpdatedISO ? new Date(lastUpdatedISO).toLocaleString() : '—'}`;
  }

  // ---- Render tables ----
  function renderRacerTeamRaces(racers) {
    const top = racers.slice().sort(byDescNum(r => r.teamRaces)).slice(0, 100);
    const tbody = document.getElementById('tbody-racer-teamRaces');
    tbody.innerHTML = top.map((r, i) => `
      <tr>
        <td class="num">${i + 1}</td>
        <td>${r.username}</td>
        <td>${r.teamTag}</td>
        <td class="num">${r.teamRaces.toLocaleString()}</td>
      </tr>
    `).join('');
  }

  function renderTenure(racers) {
    // Sort by oldest memberSince first (ascending parsed date)
    const enriched = racers.map(r => ({ r, sinceDate: parseRelativeTime(r.memberSinceStr) }));
    const top = enriched.slice().sort(byAscDate(x => x.sinceDate)).slice(0, 100);
    const tbody = document.getElementById('tbody-tenure');
    tbody.innerHTML = top.map((x, i) => `
      <tr>
        <td class="num">${i + 1}</td>
        <td>${x.r.username}</td>
        <td>${x.r.teamTag}</td>
        <td>${x.r.memberSinceStr || '—'}</td>
        <td class="num">${isoDateString(x.sinceDate)}</td>
      </tr>
    `).join('');
  }

  function renderActive(racers) {
    // Sort by most recent lastRace first (descending parsed date)
    const enriched = racers.map(r => ({ r, lastDate: parseRelativeTime(r.lastRaceStr) }));
    const top = enriched.slice().sort(byDescDate(x => x.lastDate)).slice(0, 100);
    const tbody = document.getElementById('tbody-active');
    tbody.innerHTML = top.map((x, i) => `
      <tr>
        <td class="num">${i + 1}</td>
        <td>${x.r.username}</td>
        <td>${x.r.teamTag}</td>
        <td>${x.r.lastRaceStr || '—'}</td>
        <td class="num">${isoDateString(x.lastDate)}</td>
      </tr>
    `).join('');
  }

  function renderTeamTotals(dedupedTeams) {
    // Use stats.allTime.races; include source note if missing
    const rows = dedupedTeams.map(t => {
      const teamLabel = safeTeamLabel(t);
      const all = t.stats && t.stats.allTime ? t.stats.allTime : {};
      const races = normNumber(all.races);
      const source = Number.isFinite(all.races) ? 'stats.allTime.races' : 'missing';
      return { teamLabel, races, source };
    });

    const top = rows.slice().sort(byDescNum(r => r.races)).slice(0, 100);
    const tbody = document.getElementById('tbody-team-totals');
    tbody.innerHTML = top.map((r, i) => `
      <tr>
        <td class="num">${i + 1}</td>
        <td>${r.teamLabel}</td>
        <td class="num">${r.races.toLocaleString()}</td>
        <td class="muted">${r.source}</td>
      </tr>
    `).join('');
  }

  // ---- Boot ----
  (async function boot() {
    const { deduped, ingestedCount, lastUpdatedISO } = await loadData();
    const racers = flattenRacers(deduped);

    renderSummary({
      teamsCount: deduped.length,
      racersCount: racers.length,
      ingestedCount,
      lastUpdatedISO
    });

    renderRacerTeamRaces(racers);
    renderTenure(racers);
    renderActive(racers);
    renderTeamTotals(deduped);
  })();
})();
</script>
</body>
</html>
